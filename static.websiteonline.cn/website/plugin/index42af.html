function wp_getdefaultHoverCss(layer_id)
{
	var getli='';
	var geta='';
	var cssstyle='';

	var navStyle = wp_get_navstyle(layer_id,'datasty_');
	if(navStyle.length > 0)
	{
		var patt1 = new RegExp("#nav_layer[0-9|a-z|A-Z]+\\s+li\.wp_subtop:\\s*hover\\s*{[^}]+}",'i');
		var tmp = patt1.exec(navStyle);
		if(tmp)
		{			
			var tmp1 = tmp[0].match(/{[^}]+}/)[0];
			tmp1=tmp1.replace('{','').replace('}','');
			getli=getli+tmp1;
		}
 
		patt1 = new RegExp("#nav_layer[0-9|a-z|A-Z]+\\s+li\.wp_subtop>a:\\s*hover\\s*{[^}]+}",'i');
		tmp = patt1.exec(navStyle);
		if(tmp)
		{			
			var tmp2 = tmp[0].match(/{[^}]+}/)[0];
			tmp2=tmp2.replace('{','').replace('}','');
			geta=geta+tmp2;
		}		
		
		
	}

	navStyle = wp_get_navstyle(layer_id,'datastys_');
	var getlia='';
	if(navStyle.length > 0)
	{		 
		var layidlow=('#nav_'+layer_id+' li.wp_subtop>a:hover').toLowerCase();
		if( ('a'+navStyle).toLowerCase().indexOf(layidlow)>0){			
			var parstr="#nav_"+ layer_id +" li.wp_subtop>a:hover";
			getlia = navStyle.split(new RegExp(parstr,"i"));
			var combilestr='';
			for(key in getlia){
				var ervervalue='';				
				if(('a'+getlia[key]).indexOf('{')<3 && ('a'+getlia[key]).indexOf('{')>0 ){
					var parvalue=getlia[key].split('{');
					if(('a'+parvalue[1]).indexOf('}')>0){
						ervervalue=parvalue[1].split('}')[0];
					}
				}
				combilestr=combilestr+ervervalue;
			}
			geta=geta+combilestr;
		}
		
		layidlow=('#nav_'+layer_id+' li.wp_subtop:hover').toLowerCase();
		if( ('a'+navStyle).toLowerCase().indexOf(layidlow)>0){			
			var parstr="#nav_"+ layer_id +" li.wp_subtop:hover";
			getlia = navStyle.split(new RegExp(parstr,"i"));
			var combilestrs='';
			for(var key in getlia){
				var ervervalue='';				
				if(('a'+getlia[key]).indexOf('{')<3 && ('a'+getlia[key]).indexOf('{')>0 ){
					var parvalue=getlia[key].split('{');
					if(('a'+parvalue[1]).indexOf('}')>0){
						ervervalue=parvalue[1].split('}')[0];
					}
				}
				combilestrs=combilestrs+ervervalue;
			}
			getli=getli+combilestrs;
		}
	 
		
	}
	
	if(getli.length>0){
		getli="#"+layer_id+" li.lihover{"+getli+"} ";
	}
	if(geta.length>0){
		geta="#"+layer_id+" li>a.ahover{"+geta+"} ";
	}
	cssstyle=getli+geta;
	if(cssstyle.length>0 ){
		cssstyle=""+cssstyle+"";
		cssstyle=cssstyle.replace(/[\r\n]/g, " ").replace(/\s+/g, " "); 
		var doms=$('#'+layer_id);
		var oldcssstyle=doms.data('get_layer_hover_css');
		if(oldcssstyle != cssstyle){
			$("#hover"+layer_id+"").text(""+cssstyle+"");
			doms.data('get_layer_hover_css',cssstyle);
			get_plugin_css("H"+ layer_id +"H",cssstyle);
		}
	}
}

function wp_showdefaultHoverCss(layer_id){
	var layertype=$('#'+layer_id).attr('type');
	if(layertype && window['wp_showdefaultHoverCss_'+layertype]){
		return window['wp_showdefaultHoverCss_'+layertype](layer_id);
	}
	return false;
}

function wp_showdefaultHoverCss_new_navigation(layer_id)
{
	 
	var plugin_name=$("#"+layer_id).attr('type');
	var hover=$("#"+layer_id).find('.nav1').attr('hover');
	if(hover!=1){ return;}
	
	wp_getdefaultHoverCss(layer_id);
	var n=0;
	var rootpid=0;
	if(plugin_name=='new_navigation'){
		var page_id=$("#page_id").val();
		rootpid=$("#page_id").attr("rpid")*1;
	}else{
		var page_id=$('#'+layer_id+'').find(".default_pid").html();
		if(page_id==0 || page_id.length==0){
			page_id=$('#nav_'+layer_id+'').children('li:first').attr('pid');	
		}
	}

	$('#nav_'+layer_id+'').children('li').each(function(){
		var type_pid=$(this).attr('pid');		
		if( (type_pid==page_id ) && plugin_name=='new_navigation' ){
			$(this).addClass("lihover").children('a').addClass("ahover");
		}
		$(this).hover(function(){
			$(this).children('a').addClass("ahover");
		},function(){
			if(!$(this).is('.lihover')) $(this).children('a').removeClass("ahover");
		})
		if(type_pid==rootpid && rootpid>0){
			$(this).addClass('rootlihover');
		}
		var t_bool = false;
		var whref = window.location.href.replace(/^https?:/,'').replace(/&brd=1$/,'');;
		var t_href= $(this).find("a").attr("href").replace(/^https?:/,'').replace(/&brd=1$/,'');;
 		var $nav1 =  $('#'+layer_id).children('.wp-new_navigation_content').children('.nav1');
		var sethomeurl = $nav1.attr("sethomeurl");
		if(sethomeurl) sethomeurl = sethomeurl.replace(/^https?:/,'');
		var cururl = window.location.href.replace(/^https?:/,'');
		if( (whref.indexOf("&menu_id=")>0 && t_href.indexOf("id=")>0 && whref.indexOf(t_href)>-1) || t_href == sethomeurl &&  sethomeurl.indexOf(cururl)>-1 ){
			t_bool = true;
		}
        var domainName = window.location.hostname;
        if((whref.indexOf("&menu_id=")>0 && whref.indexOf(t_href)>-1)&&t_href!=sethomeurl&&t_href!='//'+domainName){
            t_bool = true;
        }
        if(whref == t_href || whref== t_href+"&brd=1" || t_bool){ $(this).addClass("lihover").children('a').addClass("ahover"); }
		n++;
	});
	if(!$('#nav_'+layer_id+'').children('li.lihover').length){
		$('#nav_'+layer_id+'').children('li.rootlihover:first').addClass("lihover").children('a').addClass("ahover");
	}
	$('#nav_'+layer_id+' .rootlihover').removeClass('rootlihover');
}
function wp_nav_addMoreButton(layer_id)
{  
	var type_style=$("#"+layer_id).find('.wp-new_navigation_content').attr('type');
	
	var index=0;
	var exec=false;
	var func=function(){
		if(!$('#scroll_container #'+layer_id+':visible').length){
			$("#"+layer_id).unbind('more_button_event').bind('more_button_event',function(){
				index=0;
				func();
			})
			if(index<=20){
				setTimeout(func,500);
				index++;
			}
			return;
		}
		if(exec) return;
		$("#"+layer_id).unbind('more_button_event');
		exec=true;

		var firstLiTop = 0;
		var hasMore = false;
		$('#scroll_container  #nav_'+layer_id).children('li.wp_subtop').each(function(i){
			if(i == 0) {firstLiTop = $(this).offset().top;return true;}	
			if($(this).offset().top > firstLiTop)
			{
				if(i==1){
					var twice=$("#"+layer_id).data('twiced');
					if(!twice){
						$("#"+layer_id).data('twiced',true);
						setTimeout(func,1500);
						return false;
					}
				}	

				if(type_style==2){
					$(this).remove();
				}else{

				$('#'+layer_id).data('hasMore','yes');//配置逻辑获取
				var more = $.trim($('#'+layer_id).children('.wp-new_navigation_content').children('.nav1').attr('more'));
				var doms = $(this).prev().prev().nextAll().clone();
				var objA = $(this).prev().children('a');
				if(objA.children('span').length > 0) objA.children('span').html(more);
				else objA.html(more);

				if(objA.hasClass('sub'))
				{
					objA.next('ul').empty();
					doms.appendTo(objA.next('ul'));
				}
				else
				{
					objA.after('<ul></ul>');
					doms.appendTo(objA.next('ul'));
					objA.addClass('sub');
				}
				objA.addClass('nav_more_link');
				$(this).prev().nextAll().remove();
				objA.next('ul').children('li').removeClass('wp_subtop').removeClass('lihover').children('a').removeClass("ahover");
				hasMore = true;
				
				objA.attr('href','javascript:void(0);');

				//点击"更多"弹出全站导航
				if($("#"+layer_id).find('.nav1').attr('moreshow') == 1)
				{
					$(document).undelegate("#"+layer_id+" .nav_more_link",'click').delegate("#"+layer_id+" .nav_more_link",'click',function (e){
						var func=function(){
							$('#'+layer_id).find('#basic-modal-content_'+layer_id).modal({
								containerId:'wp-new_navigation-simplemodal-container_'+layer_id,
								zIndex:9999,
								close:false,
								onOpen:function(dialog){
									dialog.overlay.fadeIn('slow', function(){
										dialog.container.slideDown('slow',function(){
											dialog.data.fadeIn('slow','swing',function(){
												$('.wp_menus').not('.wp_thirdmenu0').each(function(){
													var left = $(this).parent().parent().children('a').eq(0).outerWidth()+5;
													$(this).css({position:'relative',left:left+'px'});
												});
											});
										});
									});
								},
								onClose:function(dialog){
									dialog.data.fadeOut('slow',function (){
										dialog.container.slideUp('slow', function () {
											dialog.overlay.fadeOut('slow', function () {
												$.modal.close();
											});
										});
									});
								}
							});
						}
						if($('#'+layer_id).find('#basic-modal-content_'+layer_id).length){
							func();
						}else{
							var morediv=$('#'+layer_id).find('.navigation_more');
							var more_color=morediv.attr('data-more');
							var typeval=morediv.attr('data-typeval');
							var menudata=morediv.attr('data-menudata');
							$.ajax({
								type: "POST",
								url: parseToURL("new_navigation", "windowpopup"),
								data: {layer_id:layer_id,color:more_color,typeval:typeval,menudata:menudata},
								success: function (response) {
									if (response == 'Session expired')
										window.location.href = getSessionExpiredUrl();
									morediv.replaceWith(response);
									func();
								},
								error: function (xhr, textStatus, errorThrown) {
									wp_alert(xhr.readyState + ',' + xhr.status + ' - ' + (errorThrown || textStatus) + "(get nav).<br/>" + translate("Request failed!"));
									return false;
								}
							});
						}
						return false;
					});
				
				}
				return false;
				}
			}
		});
		if(!hasMore) $('#'+layer_id).data('hasMore','no');
		wp_showdefaultHoverCss(layer_id);
	};
	func();
}

//编辑模式水平拖动动态刷新修改More按钮
function wp_updateMoreButton(layer_id)
{
	var $layer = $('#'+layer_id);
	var $nav1 = $layer.children('.wp-new_navigation_content').children('.nav1');
	var tmp_css = $.trim($("#datastys_"+layer_id).text());
	var tmp_cssa = $.trim($("#datasty_"+layer_id).text()); 
	$.post(parseToURL("new_navigation","refreshNavigator",{menustyle:$.trim($nav1.attr('skin')),saveCss:'yes',page_id:$("#page_id").val(),blockid:layer_id,typeval:$.trim($layer.find(".wp-new_navigation_content").attr('type')),colorstyle:$.trim($nav1.attr('colorstyle')),direction:$.trim($nav1.attr('direction')),more:$.trim($nav1.attr('more')),hover:$.trim($nav1.attr('hover')),hover_scr:$.trim($nav1.attr('hover_scr')),umenu:$.trim($nav1.attr('umenu')),dmenu:$.trim($nav1.attr('dmenu')),moreshow:$.trim($nav1.attr('moreshow')),morecolor:$.trim($nav1.attr('morecolor')),smcenter:$.trim($nav1.attr('smcenter'))}),{"addopts": $layer.mod_property("addopts")||{},menudata:$("#"+layer_id).data("menudata")},function(data){
		$layer.find('.wp-new_navigation_content').html(data);		
		$("#datastys_"+layer_id).text(tmp_css);
		get_plugin_css(layer_id,tmp_cssa+" "+tmp_css);
	});
	wp_showdefaultHoverCss(layer_id);
}

function wp_removeLoading(layer_id)
{
	
	var $nav1 = $('#'+layer_id).find(".nav1");
	var ishorizon=$nav1.attr("ishorizon");
	if(ishorizon=='1'){
		$("#"+layer_id).find('.wp-new_navigation_content').css({height:'auto',overflow:'hidden'});
	}else{
		$("#"+layer_id).find('.wp-new_navigation_content').css({width:'auto',overflow:'hidden'});
	}
	// 修复IE浏览器部分版本导航无法显示问题 2013/12/26
 
	var temptimer = setTimeout(function(){
		$("#"+layer_id).find('.wp-new_navigation_content').css("overflow", 'visible');
		clearTimeout(temptimer);
	}, 50);
}

function richtxt(layer_id)
{
	var type=$("#"+layer_id).find('.wp-new_navigation_content').attr('type');
	if(type==2){
		var baseloop = 0;
		 $("#"+layer_id).find('.ddli').each(function(){
			 $(this).addClass("setdiff"+baseloop);
			 baseloop++;
		 });
	}
}

function wp_createNavigationgetSubMenuHoverCssFunc(param){
	var layer_id=param.layer_id;
	var editmode=param.editmode;
	function getSubMenuHoverCss(css_pro,type){
		var typeval=type;
		if(typeval==1){
			var regex = "#nav_layer[0-9|a-z|A-Z]+\\s+ul+\\s+li+\\s+a:\\s*hover\\s*{\\s*"+css_pro+"\\s*:[^;]+";
		}else{
			var regex = "#nav_layer[0-9|a-z|A-Z]+\\s+li\.wp_subtop>a:\\s*hover\\s*{\\s*"+css_pro+"\\s*:[^;]+";
		}
		if(editmode){
			var navStyle = $.trim($("#datastys_"+layer_id).text());
		}else{
			var navStyle = $.trim($("#"+layer_id).data("datastys_"));
		}
		if(navStyle.length > 0){
			var patt1 =new RegExp(regex,'i');
			var tmp = patt1.exec($.trim(navStyle));
			if(tmp)
			{
				return $.trim((tmp[0].match(/{[^:]+:[^;]+/)[0]).match(/:[^;]+/)[0].replace(':',''));
			}
		}
		if(editmode){
			navStyle = $.trim($("#datasty_"+layer_id).text());
		}else{
			navStyle = $.trim($("#"+layer_id).data("datasty_"));
		}
		if(navStyle.length > 0)
		{
			if(typeval==1){
				var patt1 = new RegExp("#nav_layer[0-9|a-z|A-Z]+\\s+ul+\\s+li+\\s+a:\\s*hover\\s*{[^}]+}",'i');
			}else{
				var patt1 = new RegExp("#nav_layer[0-9|a-z|A-Z]+\\s+li\.wp_subtop>a:\\s*hover\\s*{[^}]+}",'i');
			}
			var tmp = patt1.exec(navStyle);

			if(tmp)
			{
				var tmp1 = tmp[0].match(/{[^}]+}/)[0];
				var patt2 = new RegExp(css_pro+"\\s*:\\s*[^;]+;",'i');
				tmp = patt2.exec(tmp1);
				if(tmp) return $.trim(tmp[0].replace(/[^:]+:/,'').replace(';',''));
			}
		}
		return $.trim($("#nav_"+layer_id+" ul li a").css(css_pro));
	}
	window[layer_id+'_getSubMenuHoverCss']=getSubMenuHoverCss;
}

function layer_new_navigation_content_func(params){
	var layer_id = params['layer_id'];
	$("#"+layer_id).find('.menu_hs11').css('visibility','hidden');
    var contentfunc=function(){
        if($("#"+layer_id).is(':visible')){
                $("#"+layer_id).find('.wp-new_navigation_content').each(function(){
                  var wid = $(this).width();
                  var liwid = $(this).find('li:eq(0)');
				  var lipadd = parseInt(liwid.css('padding-right'))+parseInt(liwid.css('padding-left'));
				  var isEmptyMenu=false;
				  if($(this).find('li.wp_subtop').length==1){
					  var menulinktxt=$(this).find('li.wp_subtop a').text();
					  if(menulinktxt=='No menu!'){
						 isEmptyMenu=true;
					  }
				  }
                  if (!isEmptyMenu && $.inArray(params.menustyle, ['hs7','hs9','hs11','hs12']) != -1) {
					  var bwidth = parseFloat(liwid.css("borderRightWidth") || '0');
					  if(bwidth>0) bwidth=Math.round(bwidth);
					  else bwidth =0;
					  $('li.wp_subtop', this).css('box-sizing','');
					  if(bwidth > 0) $('li.wp_subtop', this).width(function(i, h){return h - bwidth - 1});
					  else if(!$("#canvas").data('changewidth_'+layer_id)){
						  $("#canvas").data('changewidth_'+layer_id,true);
						  if(params.menustyle=='hs12'){
						  	$('li.wp_subtop', this).width(function(i, h){return h - 1})
						  }else{
							var totalw=0;
							$('li.wp_subtop', this).width(function(i, h){totalw+=h;return h})
							var ulwidth=$(this).find('#nav_'+layer_id).width();
							if(totalw>ulwidth){
								for(var i=0;i<totalw-ulwidth;i++){
								 	$('li.wp_subtop:eq('+i+')', this).width(function(i, h){return h - 1});
								}
							}
						  }
					  };
				  }
                  if(parseInt(liwid.width())>(wid-lipadd)){
					$(this).find('li.wp_subtop').css('width',wid-lipadd);
                  }
                });
                $("#"+layer_id).find('.menu_hs11,.menu_hs7,.menu_hs12').css('visibility','');
                var contenth=$("#"+layer_id+" .wp-new_navigation_content").height();
                if(contenth==0){
                    $("#"+layer_id+" .wp-new_navigation_content").css('height','');
                }
         }else{
                 setTimeout(contentfunc,60);
         }
    }
	contentfunc();
		if(params.isedit){$('#'+layer_id).mod_property({"addopts": params.addopts});}
	if((params.addopts||[]).length > 0 && /^hs/i.test(params.menustyle)){$('#nav_'+layer_id+' li.wp_subtop:last').css("border-right", 'none');}
    if(! params.isedit){
        if($.inArray(params.menustyle, ['vertical_vs6','vertical_vs7']) != -1){
            var $layer=$('#'+layer_id).find(".wp-new_navigation_content");
            var vswidth=$layer.width();
            var $ul=$layer.find('ul.navigation');
            $ul.css({width:vswidth+'px'});
            $ul.find("li.wp_subtop").css({width:(vswidth-14)+'px'});
        }
    }
};
function layer_new_navigation_hs12_func(params){
	var layer_id = params['layer_id'],
	menustyle = params.menustyle;
	$('.menu_hs12', '#' + layer_id).css('visibility', 'hidden');
    var nav_type = $("#"+layer_id).find('.wp-new_navigation_content').attr('type');
    window[layer_id+'_getSubMenuHoverCss'] = function(css_pro,type){
		var typeval=type;
		if(typeval==1){
			var regex = "#nav_layer[0-9|a-z|A-Z]+\\s+ul+\\s+li+\\s+a:\\s*hover\\s*{\\s*"+css_pro+"\\s*:[^;]+";
		}else{
			var regex = "#nav_layer[0-9|a-z|A-Z]+\\s+li\.wp_subtop>a:\\s*hover\\s*{\\s*"+css_pro+"\\s*:[^;]+";
		}
		
		var navStyle = wp_get_navstyle(layer_id, 'datastys_');
		if(navStyle.length > 0)
		{
			var patt1 =new RegExp(regex,'i');
			var tmp = patt1.exec($.trim(navStyle));
			if(tmp)
			{
				return $.trim((tmp[0].match(/{[^:]+:[^;]+/)[0]).match(/:[^;]+/)[0].replace(':',''));
			}
		}
		navStyle = wp_get_navstyle(layer_id, 'datasty_');
		if(navStyle.length > 0)
		{
			if(typeval==1){
				var patt1 = new RegExp("#nav_layer[0-9|a-z|A-Z]+\\s+ul+\\s+li+\\s+a:\\s*hover\\s*{[^}]+}",'i');
			}else{
				var patt1 = new RegExp("#nav_layer[0-9|a-z|A-Z]+\\s+li\.wp_subtop>a:\\s*hover\\s*{[^}]+}",'i');
			}
			var tmp = patt1.exec(navStyle);
			
			if(tmp)
			{
				var tmp1 = tmp[0].match(/{[^}]+}/)[0];
				var patt2 = new RegExp(css_pro+"\\s*:\\s*[^;]+;",'i');
				tmp = patt2.exec(tmp1);
				if(tmp) return $.trim(tmp[0].replace(/[^:]+:/,'').replace(';',''));
			}
		}

		return $.trim($("#nav_"+layer_id+" ul li a").css(css_pro));
	};
	
	$('#'+layer_id).layer_ready(function(){
		setTimeout(function(){
			wp_nav_addMoreButton(layer_id);
			var m_show = $('#'+layer_id).data("m_show")||'';		
			if(m_show=="none"){
				$('#'+layer_id).find(".wp_subtop").removeClass('lastsubtop');
				$('#'+layer_id).find(".wp_subtop:last").addClass('lastsubtop');
			}
		},0);
		$('#nav_'+layer_id).find('li').hover(function(){
			if(params.isedit){
				var resizehandle = parseInt($('#'+layer_id).children('.ui-resizable-handle').css('z-index'));
				if($(this).hasClass('wp_subtop')) $(this).parent().css('z-index',resizehandle+1);
				var canvas_zindex = $('#canvas').css('z-index');
				var $toolbar = $(".propblk[super='"+layer_id+"']");
				if($toolbar.length > 0)  $toolbar.css('z-index',canvas_zindex - 1);
			}
			var smcenter=$("#"+layer_id).find('.nav1').attr('smcenter');
			if ($(this).hasClass('wp_subtop')) {
				if (smcenter == 1) {
					var w = $(this).outerWidth();
					var cw = $(this).children('ul').outerWidth();
					var cl = parseInt((cw - w)/2);
				} else {
					var cl = 0;
				}
			}
			$(this).children('ul').css('left','-'+cl+'px').show();
			var type=$("#"+layer_id).find('.wp-new_navigation_content').attr('type');
			if(type==2){
				var self = $(this);
				var pos = 0 ;
				var loops = 0;
				$('#nav_'+layer_id).find('li').each(function(){
					if(loops == 1) return true;
					if(self.html() == $(this).html()){
						loops = 1;
						return true;
					}else{
						pos = pos + $(this).outerWidth();
					}	
					 
				})
				 
				$("#"+layer_id).find('.ddli').hide();
				var this_width = $('#nav_'+layer_id).outerWidth();
				var thisul_left = $('#nav_'+layer_id).css("padding-left");
				thisul_left = parseInt(thisul_left);
				$(this).children('.ddli').outerWidth(this_width).css("margin-left","-"+(thisul_left+pos+5)+"px");
				$(this).children('.ddli').eq(0).slideDown();
			}
		},function(){
			$(this).children('ul').hide();

			if(params.isedit){
				var resizehandle = parseInt($('#'+layer_id).children('.ui-resizable-handle').css('z-index'));
				var isHover = true;
				$('#nav_'+layer_id).find('ul').each(function(){
					if($(this).css('display') != 'none') {isHover = false;return false;}
				});
				if(isHover){
					if(!($.browser.msie && $.browser.version < 9)) $(this).parent().css('z-index',resizehandle-1);
					var $toolbar = $(".propblk[super='"+layer_id+"']");
					if($toolbar.length > 0)  $toolbar.css('z-index','999');
				}
			}
			var type=$("#"+layer_id).find('.wp-new_navigation_content').attr('type');
			if(type==2){
				$("#"+layer_id).find('.ddli').slideUp();
			}
		});
		
		//子菜单位置设置
		$(".menu_"+menustyle+" #nav_"+layer_id).find('li').mouseenter(function(){
			var firstLi = $(this);
			var firestLiouterWidth = firstLi.outerWidth();
			var tmp_max_width = 0;
			firstLi.children('ul').children('li').each(function(){
			    // 需求编号 8317
                var align_value = $(this).css("text-align");
                if (nav_type == 0 && align_value && align_value == "center") {
                    $(this).css({"padding": 0});
                    $(this).children("a").css({"display": "inline-block", "width": "100%"});
                }
                if ($(this).outerWidth() < firestLiouterWidth) {
                    $(this).width(firestLiouterWidth - parseInt($(this).css('padding-left')) - parseInt($(this).css('padding-right')));
                } else if ($(this).outerWidth() > tmp_max_width) {
                    tmp_max_width = $(this).outerWidth();
                }
			});
				
			if(tmp_max_width > 0) firstLi.children('ul').children('li').each(function(){
				$(this).width(tmp_max_width - parseInt($(this).css('padding-left')) - parseInt($(this).css('padding-right')));
			});
				
			if(firstLi.parent('ul').attr('id') != 'nav_'+layer_id)
				firstLi.children('ul').css('margin-left',firstLi.outerWidth());
			tmp_max_width = 0;
		});

		//第三级即下级菜单随高度增加位置动态修改
		$(".menu_"+menustyle+" #nav_"+layer_id+" ul li").hover(function(){
			if($(this).children('ul').length > 0)
			{
				var marginTop = parseInt($(this).children('ul').css('margin-top'));
				if($(this).children('ul').offset().top > $(this).offset().top)
					$(this).children('ul').css('margin-top',marginTop - ($(this).children('ul').offset().top - $(this).offset().top) + 'px');
			}
		});

		$('.menu_'+menustyle+' #nav_'+layer_id).find('li').hover(function(){
			var direction=$("#"+layer_id).find('.nav1').attr('direction');
			var height = parseInt($(this).outerHeight());
			if($(this).parent().hasClass('navigation'))
			{		
				$('#nav_'+layer_id+' .wp_subtop').removeClass("lihover").children('a').removeClass("ahover");
				if(direction==1){				
					$(this).children('ul').css('top','auto').css('bottom',height + 'px');
				}else{				
					$(this).children('ul').css('top',height+'px').css('bottom','auto');	
				}
				$(this).children('a').css({'font-family':window[layer_id+'_getSubMenuHoverCss']("font-family",0),'font-size':window[layer_id+'_getSubMenuHoverCss']("font-size",0),'color':window[layer_id+'_getSubMenuHoverCss']("color",0),'font-weight':window[layer_id+'_getSubMenuHoverCss']("font-weight",0),'font-style':window[layer_id+'_getSubMenuHoverCss']("font-style",0)});
			}else{
				if(direction==1){
					$(this).children('ul').css('top','auto').css('bottom', '-0px');
				}else{
					$(this).children('ul').css('top',height+'px').css('bottom','auto');					
				}
				$(this).children('a').css({'font-family':window[layer_id+'_getSubMenuHoverCss']("font-family",1),'font-size':window[layer_id+'_getSubMenuHoverCss']("font-size",1),'color':window[layer_id+'_getSubMenuHoverCss']("color",1),'font-weight':window[layer_id+'_getSubMenuHoverCss']("font-weight",1),'font-style':window[layer_id+'_getSubMenuHoverCss']("font-style",1)});
			}
		},function(){
			if($(this).parent().hasClass('navigation'))
			{
				wp_showdefaultHoverCss(layer_id);
			}
			$(this).children('a').attr("style",'');
            // 需求编号 8317
            var align_value = $(this).css("text-align");
			if (nav_type == 0 && !$(this).parent().hasClass('navigation') && align_value && align_value == "center") {
                $(this).children("a").css({"display": "inline-block", "width": "100%"});
            }
        });
		wp_showdefaultHoverCss(layer_id);
		wp_removeLoading(layer_id);
	});
};
function detectZoom (){ 
    var ratio = 0,
    screen = window.screen,
    ua = navigator.userAgent.toLowerCase() || '';
    if (window.devicePixelRatio !== undefined) {
        ratio = window.devicePixelRatio;
    }else if (~ua.indexOf('msie')) {  
        if (screen.deviceXDPI && screen.logicalXDPI) {
            ratio = screen.deviceXDPI / screen.logicalXDPI;
        }
    }else if (window.outerWidth !== undefined && window.innerWidth !== undefined) {
        ratio = window.outerWidth / window.innerWidth;
    }
    if (ratio){
        ratio = Math.round(ratio * 100);
    }
    return ratio;
}

function layer_unslider_heightAdapt_func(dom,params){
	var wsize=params.wsize;
	if(params.unslideradapt!='1') return;
	if(!wsize || !wsize.width) return;
	if(params.editMode) return;
	var lastW=dom.data('lastW');
	var winW=dom.find('.wp-unslider_content').width();
	dom.data('lastW',winW);
	if(winW==lastW) return;
	var curH=dom.height();
	var editH=parseInt(wsize.height)
	if(wsize.width>=winW && curH<=editH) return;
	var curH=editH;
	if(wsize.width<winW) curH=parseInt(curH*winW/wsize.width);
	dom.css('height',curH+'px');
	dom.find('.wp-unslider_content').css('height',curH+'px');
	var adaptfunc=function(){
		var heightfunc=function(){
			return editH;
		}

		var layer_first_div=function(el){
			var firstdiv=el.children('div').eq(0);
			return firstdiv;
		}
		
		var resetPos=function(el){
			var oritop=el.data('adaptoritop');
			var oriheight=el.data('adaptoriheight');
			var pressArr=el.data('adaptpress');
			var wrapArr=el.data('adaptwrap');
			var id=dom.prop('id');
			var toppos=$.parseInteger(el.css('top'));
			if(el.data('wopop_effect_oristyle')){
				var style=el.data('wopop_effect_oristyle');
				var topregexp=/(?:^|;)\s*top\s*:\s*(\d+)px/;
				var topmatches=style.match(topregexp);
				if(topmatches){
					toppos=parseInt(topmatches[1]);
				}
			}
			if(!oritop&&oritop !==0){
				el.data('adaptoritop',toppos);
				el.data('adaptoriheight',el.height());
				return;
			}

			if(pressArr && pressArr.length){
				var newpressarr=[]
				for(var i=0;i<pressArr.length;i++){
					var press=pressArr[i];
					if(press.id !=id){
						oritop+=press.diffY;
						newpressarr.push(press)
					}
				}
				el.data('adaptpress',newpressarr);
			}
			
			if(wrapArr && wrapArr.length){
				var h=oriheight;
				for(var i=0;i<wrapArr.length;i++){
					var wrap=wrapArr[i];
					if(wrap.id !=id){
						h+=wrap.diffH;
					}
				}
				if(h!=el.height()){
					el.css('height',h+'px');
					var wrapListPadding = parseInt(layer_first_div(el).css('padding-top')) + parseInt(layer_first_div(el).css('padding-bottom'));
					var wrapListBorder = parseInt(layer_first_div(el).css('border-top-width')) + parseInt(layer_first_div(el).css('border-bottom-width'));
					layer_first_div(el).height(el.height() - wrapListPadding - wrapListBorder);
				}
			}
			if(oritop!=toppos){ 
				if(el.data('wopop_effect_oristyle')){
					var style=el.data('wopop_effect_oristyle');
					style=style.replace(/((?:^|;)\s*top\s*:\s*)\d+px;/,'$1'+oritop+'px;');
					el.data('wopop_effect_oristyle',style);
				}
				el.css('top',oritop+'px');
			}
		}
		
		var canvheight=$('#canvas').data('adaptoriheight');
		if(!canvheight){
			$('#canvas').data('adaptoriheight',$('#canvas').height());
			canvheight=$('#canvas').data('adaptoriheight');
		}
		var adaptModuleBefore = heightfunc();//自适应之前原始高度
		resetPos(dom);
		//有些模块第一个元素不是div，比如：产品详情
		var adaptModuleAfter = curH;//自适应之后高度

		//bug 7531 特殊处理  限定mbox内 且高度差不高于10
		var adaptdoms=$('#canvas').data('heightadaptdoms');
		if(!adaptdoms) adaptdoms=[];
		var domfatherid=dom.attr('fatherid');
		var sameTopDiff=0;
		if(domfatherid&&domfatherid!=''&&domfatherid!='canvas' && domfatherid!='site_footer'){
			adaptdoms.push({id:dom.prop('id'),diff:adaptModuleAfter-adaptModuleBefore});
			$('#canvas').data('heightadaptdoms',adaptdoms);
		}

		var moduleLayerHeight = adaptModuleBefore;
		var moduleHeight = layer_first_div(dom).outerHeight();//模块取 wp-模块名_content层的高度
		
		var moduleTop = dom.ab_pos_cnter('top');//获取画布坐标系y值
		
		var left_boundray = 0;//左右边界
		var right_boundray = $('#canvas').width();
		
		var offsetY = 0;//发生重合后往下压位置与高度自适应模块空出原有高度
		var pressList = new Array();//记录往下压的模块列表
		var wrapList = new Array();//包在高度自适应外层模块列表
		
		var minTop = 0,minId = 0;
		//页面上的模块可能有不同坐标系，但往下压多少像素的相对偏移量都相同的，获取这些偏移量
		var diffY = 0;//向下移动偏移量
		
		$("#canvas").find('.cstlayer,.full_column').each(function(){
			//判断页面模块是不是在高度自适应模块左右边界中,通栏模块肯定在,不需要判断
			resetPos($(this));
			var tmp_left = $(this).ab_pos_cnter('left');
			var tmp_top =$(this).ab_pos_cnter('top'),tmp_width = $(this).outerWidth(),tmp_height = $(this).outerHeight();
			if($(this).data('wopop_effect_oristyle')){
				var style=$(this).data('wopop_effect_oristyle');
				var topregexp=/(?:^|;)\s*top\s*:\s*(\d+)px/;
				var topmatches=style.match(topregexp);
				if(topmatches){
					var toppos=parseInt(topmatches[1]);
					tmp_top=tmp_top-parseInt($(this).css('top'))+toppos;
				}
			}
			if($(this).hasClass('cstlayer'))
			{
				if(tmp_left + tmp_width < left_boundray) return true;
				if(tmp_left > right_boundray) return true;
				if(dom.attr('id') == $(this).attr('id'))  return true;//自己除外
				//包在高度自适应模块外面的模块也要改变高度
				if((tmp_left <= left_boundray && tmp_left+tmp_width >= right_boundray) && (tmp_top <= moduleTop && tmp_top+tmp_height >= moduleTop+moduleLayerHeight))
				{
					wrapList.push($(this).attr('id'));
					return true;
				}
			}
			if($(this).parent().hasClass('full_content') || $(this).parent().hasClass('footer_content') || $(this).parent().hasClass('drop_box')) return true;//通栏和底部元素暂时不考虑
			if(tmp_top >= (moduleTop + moduleLayerHeight))
			{
				pressList.push($(this).attr('id'));
				if(minTop == 0) {minTop = tmp_top;minId = $(this).attr('id');}
				else
				{
					if(minTop > tmp_top) {minTop = tmp_top;minId = $(this).attr('id');}
				}
			}
		});
		//ceshi
		offsetY = $("#"+minId).ab_pos_cnter('top') - (moduleTop + moduleLayerHeight);

		if(pressList.length > 0 && (moduleTop + moduleHeight) >= minTop)
		{
			diffY = moduleTop + moduleHeight + offsetY - minTop;
			for(var i = 0;i < pressList.length;i++)
			{
				var theel=$("#"+pressList[i]);
				var eltop=parseInt(theel.ab_pos_cnter('top'))+diffY-sameTopDiff;
				theel.css('top',eltop+'px');
				//bug 5996 自适应导致模块style变化了，动画出错
				if(theel.data('wopop_effect_oristyle')){
					var style=theel.data('wopop_effect_oristyle');
					style=style.replace(/((?:^|;)\s*top\s*:\s*)\d+px;/,'$1'+eltop+'px;');
					theel.data('wopop_effect_oristyle',style);
				}
				var pressArrOld=theel.data('adaptpress');
				if(!pressArrOld) pressArrOld=[];
				var pressArr=[];
				for(var j=0;j<pressArrOld.length;j++){
					if(pressArrOld[j].id != dom.prop('id')) pressArr.push(pressArrOld[j]);
				}
				pressArr.push({id:dom.prop('id'),diffY:diffY-sameTopDiff});
				theel.data('adaptpress',pressArr);
			}
		}
		
		if(wrapList.length > 0)
		{
			for(var i = 0;i < wrapList.length;i++)
			{
				var diffH=moduleHeight-moduleLayerHeight;
				var theel=$("#"+wrapList[i]);
				theel.height($("#"+wrapList[i]).height()+(diffH));
				var wrapListPadding = parseInt(layer_first_div(theel).css('padding-top')) + parseInt(layer_first_div($("#"+wrapList[i])).css('padding-bottom'));
				var wrapListBorder = parseInt(layer_first_div(theel).css('border-top-width')) + parseInt(layer_first_div($("#"+wrapList[i])).css('border-bottom-width'));
				layer_first_div(theel).height(theel.height() - wrapListPadding - wrapListBorder);
				var wrapArrOld=theel.data('adaptwrap');
				if(!wrapArrOld) wrapArrOld=[];
				var wrapArr=[];
				for(var j=0;j<wrapArrOld.length;j++){
					if(wrapArrOld[j].id != dom.prop('id')) wrapArr.push(wrapArrOld[j]);
				}
				wrapArr.push({id:dom.prop('id'),diffH:diffH});
				theel.data('adaptwrap',wrapArr);
				// fixed bug#4119 - Add 'custom-listener-event'
				var events = theel.data("events") || {};
				if (events.hasOwnProperty("wrapmodheightadapt"))
					theel.triggerHandler("wrapmodheightadapt");
			}
		}
		
		var nowcanvheight=$('#canvas').height();
		if(nowcanvheight != canvheight) $('#canvas').css('height',canvheight);
		setTimeout(function(){
			scroll_container_adjust();
		},100);
	}
	$(document).ready(function(){
		adaptfunc();
	})
}

function layer_unslider_init_func(params){
    var layerid = params.layerid;
    var module_height =params.module_height;
	if (layerid.length == 0) return;
	var layerel=$('#'+layerid);
    //Set module height start
    if(module_height && parseInt(module_height)){
        $('#'+layerid).css('height',module_height+'px').removeAttr('module_height');
        $('#'+layerid+' .wp-resizable-wrapper').css('height',module_height+'px');
    }//Set module height end
	var $content = $('#'+layerid+'_content');
	var bsize =(params.pstyle != 'none') ? params.plborder_size : '0';
	$content.css("border", params.pstyle);
	var fullparent = $content.parents('.fullpagesection').length;
	var borderwidth = 2 * parseInt(bsize),cntheight = $content.parent().height() - borderwidth,cnvpos = $('#canvas').offset();
	if(fullparent) { cnvpos.left = Math.abs($('.fullpagesection').css('left').replace('px','')); }
	cnvpos.left += $._parseFloat($('#canvas').css("borderLeftWidth")) + $('#scroll_container').scrollLeft();
	var canwidth = $('#scroll_container_bg').width()<$('#canvas').width()?$('#canvas').width():$('#scroll_container_bg').width();
	if(fullparent) { canwidth = $(window).width(); }
	if(cnvpos.left<0) cnvpos.left=0;
	$content.css({left: (0-cnvpos.left)+'px',width: (canwidth - borderwidth)+'px',height: cntheight+'px'});
	$('#'+layerid).css({left: '0',width: $('#canvas').width()});
	$('#'+layerid+' .banner').css("min-height", cntheight+'px'); $('#'+layerid+' .banner').css("height", cntheight+'px');
	$('#'+layerid+' .bannerul').css("height", cntheight+'px');
	$('#'+layerid+' .banner ul li').css("min-height", cntheight+'px').css('width',($('#scroll_container_bg').width() - borderwidth)+'px');$('#'+layerid+' .banner ul li').css("height", cntheight+'px');
	$('#'+layerid+' .banner .inner').css("padding", cntheight/2+'px 0px');
	var titlebarfunc=$.noop;
	var wsizefunc=function(h){
		if(params.unslideradapt!='1') return;
		if(params.editMode) return;
		var $content = $('#'+layerid+'_content');
		var bsize =(params.pstyle != 'none') ? params.plborder_size : '0';
		var borderwidth = 2 * parseInt(bsize),cntheight = $content.parent().height() - borderwidth,cnvpos = $('#canvas').offset();
		cnvpos.left += $._parseFloat($('#canvas').css("borderLeftWidth")) + $('#scroll_container').scrollLeft();
		var canwidth = $('#scroll_container_bg').width()<$('#canvas').width()?$('#canvas').width():$('#scroll_container_bg').width();
		if(cnvpos.left<0) cnvpos.left=0;
		$content.css({left: (0-cnvpos.left)+'px',width: (canwidth - borderwidth)+'px',height: cntheight+'px'});
		layer_unslider_heightAdapt_func($('#'+layerid),params)
		cntheight = $content.parent().height() - borderwidth;
		h.options.height=cntheight;
		h.createStyle();
		h.container.css("width","100%");
		h.options.navmarginy=cntheight-39;
		$('#'+layerid).trigger('changenavpos');
		titlebarfunc();
	}
	$('#'+layerid).data('wsize_func',wsizefunc);
	$('#'+layerid).layer_ready(function(){
		var ctrldown = false;
		$(window).resize(function(){
				if(!ctrldown){
					var func=function(){
						var $content = $('#'+layerid+'_content');
						var bsize =(params.pstyle != 'none') ? params.plborder_size : '0';
						var borderwidth = 2 * parseInt(bsize),cntheight = $content.parent().height() - borderwidth,cnvpos = $('#canvas').offset();
						cnvpos.left += $._parseFloat($('#canvas').css("borderLeftWidth")) + $('#scroll_container').scrollLeft();
						var canwidth = $('#scroll_container_bg').width()<$('#canvas').width()?$('#canvas').width():$('#scroll_container_bg').width();
						if(cnvpos.left<0) cnvpos.left=0;
						$content.css({left: (0-cnvpos.left)+'px',width: (canwidth - borderwidth)+'px',height: cntheight+'px'});
					}
					setTimeout(func,0);
					$('#scroll_container_bg').one('after_resize',function(){
						func();
					});
				}
		})
		$(window).keydown(function(event){
				if(!event.ctrlKey){
					var $content = $('#'+layerid+'_content');
					var bsize =(params.pstyle != 'none') ? params.plborder_size : '0';
					var borderwidth = 2 * parseInt(bsize),cntheight = $content.parent().height() - borderwidth,cnvpos = $('#canvas').offset();
					cnvpos.left += $._parseFloat($('#canvas').css("borderLeftWidth")) + $('#scroll_container').scrollLeft();
					var canwidth = $('#scroll_container_bg').width()<$('#canvas').width()?$('#canvas').width():$('#scroll_container_bg').width();
					if(cnvpos.left<0) cnvpos.left=0;
					$content.css({left: (0-cnvpos.left)+'px',width: (canwidth - borderwidth)+'px',height: cntheight+'px'});

				}else{
					ctrldown = true;
				}
		})
	})
	$('#'+layerid).layer_ready(function(){
        var transitionstr=params.easing;
        var transitiononfirstslide='';
		if(params.easing=='all'){
			transitionstr=($.browser.msie) ? "slide,slice,blocks,blinds,fade,shrink" : "slide,slice,blocks,blinds,shuffle,threed,fade,shrink";
		}
		if(transitionstr == 'shrink') {
		    transitiononfirstslide = 'shrink';
        }
		if(params.default_show=='1'){
			var arrow_show='always';
		}
		if(params.hover_show=='1'){
			var arrow_show='mouseover';
		}

		layer_unslider_heightAdapt_func($('#'+layerid),params)

			var $content = $('#'+layerid +' #'+layerid +'_content');
			var cntheight = $content.parent().height();
			cntheight = $('#'+layerid+' .wp-unslider_content').height();
			if(cntheight=='') cntheight=267;
			var  cnpos = $('#'+layerid+' .wp-unslider_content').offset();
			var contentpos = (cntheight)-39;
			if(!params.arrow_left){
				var arrow_left='template/default/images/left_arrow.png';
			}else{
				var arrow_left=params.arrow_left;
			}
			if(!params.arrow_right){
				var arrow_right='template/default/images/right_arrow.png';
			}else{
				var arrow_right=params.arrow_right;
			}
			var scripts = document.getElementsByTagName("script");
			var jsFolder = "";
			for (var i= 0; i< scripts.length; i++)
			{
					if( scripts[i].src && scripts[i].src.match(/lovelygallery\.js/i))
					jsFolder = scripts[i].src.substr(0, scripts[i].src.lastIndexOf("index.html") + 1);
			}

			var navW=12;var navH=12;
			if(params.iconstyle=='style1'){
				navW=20;navH=params.nav_height_size;
			}
			$LAB
			.script(relativeToAbsoluteURL('plugin/unslider/js/html5zoo4290.js?v=25')).wait(function(){
				if($('#'+layerid).data('wp_htmlzoo')) return;
				$('#'+layerid).data('wp_htmlzoo',true);
				var win_width = $('#scroll_container_bg').width();
				jQuery("#"+layerid+"html5zoo-1").html5zoo({
					jsfolder:jsFolder,
					transitiononfirstslide:transitiononfirstslide,
					width:win_width,height:cntheight,
					skinsfoldername:"",loadimageondemand:false,isresponsive:false,
					addmargin:true,randomplay:false,
					slideinterval:params.interval,     // 控制时间
					loop:0,
					autoplay:params.autoplays=='false'?false:true,
					skin:"Frontpage",
					navbuttonradius:0,
					navmarginy:contentpos,showshadow:false,
					navcolor:"#999999",
					texteffect:"fade",
					navspacing:12,
					arrowtop:50,
					textstyle:"static",
					navpreviewborder:4,
					navopacity:0.8,
					shadowcolor:"#aaaaaa",
					navborder:4,
					navradius:0,
					navmarginx:16,
					navstyle:"bullets",
					timercolor:"#ffffff",
					navfontsize:12,
					navhighlightcolor:"#333333",
					navheight:navH,navwidth:navW,
					navshowfeaturedarrow:false,
					titlecss:"display:block;position:relative;font:"+params.title_size+"px "+params.title_family+"; color:"+params.title_color+";",//font style
					arrowhideonmouseleave:500,
					arrowstyle:params.skin=='01'?'none':arrow_show,
					texteffectduration:win_width,
					border:0,
					timerposition:"bottom",
					navfontcolor:"#333333",
					borderradius:0,
					textcss:"display:block; padding:12px; text-align:left;",
					navbordercolor:"#ffffff",
					textpositiondynamic:"bottomleft",
					ribbonmarginy:0,
					ribbonmarginx:0,
					unsliderheight:cntheight,
					unsliderlid:layerid,
					arrowimage_left:arrow_left,
					arrowimage_right:arrow_right,
                    nav_arrow_w_size:params.nav_arrow_w_size,
                    nav_arrow_h_size:params.nav_arrow_h_size,
					navigation_style:params.navigation_style,
					navbg_hover_color:params.navbg_hover_color,
					nav_margin_bottom:params.nav_margin_bottom_size,
					nav_arrow:params.nav_arrow,
					nav_margin_left:params.nav_margin_left_size,
					nav_margin_right:params.nav_margin_right_size,
					skin:params.skin,
					pauseonmouseover:params.pauseonmouseover=='1'?true:false,
					slide: {
                        duration:win_width,
                        easing:"easeOutCubic",
                        checked:true
					},
					shrink: {
						duration:params.interval, // 缩放特效 持续时间配置
						easing:"easeOutCubic",
						scale:1.1, // 缩放特效 初始放大倍数配置
						checked:true
					},
					crossfade: {
                        duration:win_width,
                        easing:"easeOutCubic",
                        checked:true
					},
					threedhorizontal: {
                        checked:true,
                        bgcolor:"#222222",
                        perspective:win_width,
                        slicecount:1,
                        duration:1500,
                        easing:"easeOutCubic",
                        fallback:"slice",
                        scatter:5,
                        perspectiveorigin:"bottom"
					},
					slice: {
                        duration:1500,
                        easing:"easeOutCubic",
                        checked:true,
                        effects:"up,down,updown",
                        slicecount:10
					},
					fade: {
                        duration:win_width,
                        easing:"easeOutCubic",
                        checked:true,
                        effects:"fade"
					},
					blocks: {
                        columncount:5,
                        checked:true,
                        rowcount:5,
                        effects:"topleft,bottomright,top,bottom,random",
                        duration:1500,
                        easing:"easeOutCubic"
					},
					blinds: {
                        duration:2000,
                        easing:"easeOutCubic",
                        checked:true,
                        slicecount:3
					},
					shuffle: {
                        duration:1500,
                        easing:"easeOutCubic",
                        columncount:5,
                        checked:true,
                        rowcount:5
					},
					threed: {
                        checked:true,
                        bgcolor:"#222222",
                        perspective:win_width,
                        slicecount:5,
                        duration:1500,
                        easing:"easeOutCubic",
                        fallback:"slice",
                        scatter:5,
                        perspectiveorigin:"right"
					},
				 transition: transitionstr	
			});
			//html5zoo-text position
			var fontheight = $('#'+layerid+' .unslidertxtf').height();
			var textheight = parseInt(params.title_size)+10;
			if(params.show_title=='1'){					
					if($('#'+layerid+' .html5zoo-text-bg-1').css('display')=='none'){
						var fv = parseInt($('#'+layerid+' .html5zoo-title-1').css('font-size'));
						var sv = parseInt($('#'+layerid+' .html5zoo-text-1').css('padding-top'));
						fontheight = fv+sv*2;
					}else if(fontheight<textheight){
						fontheight = fontheight+textheight;
					}
			}
			titlebarfunc=function(){
				var cntheight = $('#'+layerid+' .wp-unslider_content').height();
				$('#'+layerid+' .unslidertxtf').css({'top':(cntheight-fontheight)});
			}
			titlebarfunc();
			jQuery("#"+layerid+"html5zoo-1").bind('html5zoo.switchtext',function(){
				var fontheight = $('#'+layerid+' .unslidertxtf').height();
				var textheight = parseInt(params.title_size)+10;
				if(params.show_title=='1'){					
						if($('#'+layerid+' .html5zoo-text-bg-1').css('display')=='none'){
							var fv = parseInt($('#'+layerid+' .html5zoo-title-1').css('font-size'));
							var sv = parseInt($('#'+layerid+' .html5zoo-text-1').css('padding-top'));
							fontheight = fv+sv*2;
						}else if(fontheight<textheight){
							fontheight = fontheight+textheight;
						}
				}
				var cntheight = $('#'+layerid+' .wp-unslider_content').height();
				$('#'+layerid+' .unslidertxtf').css({'top':(cntheight-fontheight)});
			});
			
			if(params.show_nav=='0'){				
				$('#'+layerid+' .dotsnew-nav').css({'display':'none'});
			}
		});    
	});
	
};
function layer_media_init_func(layerid,params){
	var $curlayer=$('#'+layerid), _duration = -1;
	$('#wp-media-image_'+layerid).off('mouseover').mouseover(function (event) {
		if($curlayer.data('wopop_effects') && $curlayer.hasClass('now_effecting')){
			return;
		}
		var effect=$curlayer.data('wopop_imgeffects');
		var $this=$(this);
		var running=$this.data('run');
		if(effect && running!=1){
			var effectrole = effect['effectrole'];
			var dset = effect['dset']; 
			var effectel=$curlayer;
			if(effectrole=='dantu' &&  effect['effect']=="effect.rotation"){
				$curlayer.data('iseffectrotate',true);
				effectel=$curlayer.find('.wp-media_content');
			}else if(effectrole !='dantu' && dset && dset['effect']=="effect.rotation"){
				$curlayer.data('iseffectrotate',true);
				effectel=$curlayer.find('.wp-media_content'); 
			}else if(effect['effect_on_img'] && effectrole=='dantu' &&  effect['effect']=="effect.zoomin"){
				effectel=$curlayer.find('img'); 
			}
			
			effectel.setimgEffects(true,effect,1);

			if(effectrole !='dantu' && dset && effect['effect_on_img'] &&  dset['effect']=="effect.zoomin"){
				effectel=$curlayer.find('img.paragraph_image'); 
				$curlayer.data('iseffectrotate',true);
			}	
			
			if(effectrole !='dantu' && typeof(dset)!="undefined"){
				// fixed bug#5949
				if ($curlayer.hasClass('now_effecting')) {
					_duration = dset.duration;
					$curlayer.wopop_effect_command('stop');
				}
				var temp_effect = {};
				temp_effect['type'] = effect['type'];
				temp_effect['effectrole'] = 'dantu';
				temp_effect['effect'] = effect['dset']['effect'];
				temp_effect['duration'] =  effect['dset']['duration'];
				effectel.setimgEffects(true,temp_effect,1);
			}
		}
	});
	// fixed bug#5949
	$curlayer.mouseleave(function(e){
		var $target = $(this), _tt = parseInt(_duration);
		if (!isNaN(_tt) && _tt >= 0 && !$target.hasClass('now_effecting')) {
			var timer = setTimeout(function(){
				$target.showEffects();
				_duration = -1;
				clearTimeout(timer);
			}, _tt);
		}
	});

	var imgover=$('#wp-media-image_'+layerid).closest('.img_over');
	imgover.children('.imgloading').width(imgover.width()).height(imgover.height());
	imgover.css('position','relative');
	$('#'+layerid).layer_ready(function(){
		layer_img_lzld(layerid);
	});
	if(!params.isedit && !params.has_effects){
		if ($('#'+$('#'+layerid).attr('fatherid')).attr('type') == 'pop_up') {
			$('#wp-media-image_'+layerid).attr('src',params.img_src);
			$('#wp-media-image_'+layerid).parents('.img_over:first').children('.imgloading').remove();
		}
	}
	
}
;
var getScrollbarWidth = function() {
    var odiv = document.createElement('div'),
        styles = { width: '100px',height: '100px',overflowY: 'scroll'}, i, scrollbarWidth;
    for (i in styles) odiv.style[i] = styles[i];
    document.body.appendChild(odiv);
    scrollbarWidth = odiv.offsetWidth - odiv.clientWidth;
    odiv.remove();
    return scrollbarWidth;
}
var btnFloat =function(data,layid){
    $layid = $('#'+layid)
    var btf_right = data.float_right?data.float_right:1
    var btf_bottom = data.float_bottom?data.float_bottom:1	
    if(data.float_enable=='show'){
        var gscrollWidth = 18;
        gscrollWidth = getScrollbarWidth();
        btf_right = parseInt(gscrollWidth) + parseInt(btf_right);
        $layid.hide()
		var effects=$layid.data('wopop_effects');
		var noclass='cstlayer';
		if(effects&&effects.effect){noclass=' ';}
        $layid.removeClass(noclass).appendTo('body').attr('style','')
        .css({"position":"fixed","right":btf_right+"px","z-index": "999","bottom":btf_bottom+"px"}).show()
    }
}

function layer_buttons_text_display_func(param){
    var layerid=param.layerid;
    var bgFlag =param.bgFlag;
	var bhFlag =param.bhFlag;
    if(bgFlag){
		$('#'+layerid).find('.wp-buttons_content a.btnarea ').find("span.button_btndefault-label").hide();
    }

	$('#'+layerid).find('.wp-buttons_content a.btnarea').hover(function () {
		if(bhFlag){
			$(this).find("span.button_btndefault-label").hide();
		}else{
			$(this).find("span.button_btndefault-label").show();
		}
	},function () {
		if(bgFlag){
			$(this).find("span.button_btndefault-label").hide();
		}else{
			$(this).find("span.button_btndefault-label").show();
		}
	});
}

;
(function($){

	var patterns = {
		text: /^['"]?(.+?)["']?$/,
		url: /^url\(["']?(.+?)['"]?\)$/
	};

	function clean(content) {
		if(content && content.length) {
			var text = content.match(patterns.text)[1],
				url = text.match(patterns.url);
			return url ? '<img src="' + url[1] + '" />': text;
		}
	}

	function inject(prop, elem, content) {
		if(prop != 'after') prop = 'before';
		if(content = clean(elem.currentStyle[prop])) {
			$(elem)[prop == 'before' ? 'prepend' : 'append'](
				$(document.createElement('span')).addClass(prop).html(content)
			);
		}
	}

	$.pseudo = function(elem) {
		inject('before', elem);
		inject('after', elem);
		elem.runtimeStyle.behavior = null;
	};
	
	if(document.createStyleSheet) {
		var o = document.createStyleSheet(null, 0);
		o.addRule('.dummy','display: static;');
		o.cssText = 'html, head, head *, body, *.before, *.after, *.before *, *.after * { behavior: none; } * { behavior: expression($.pseudo(this)); }';
	}

})(jQuery);;
function layer_new_message_form_createfuncs(params,langarr){
    var layerid =params.layerid;
    var $curlayer = $('#'+layerid);
    
    function valueRegExp(iname){
        var regRes = iname.match(/mes\[\w+\-(\w\d+)\]/);
        return regRes[1];
    }

    //ms5样式，调整因为三级联动展开和上传图片时表单项的高度变化，同行元素保持高度一致
	function ms5Hig($curli){
		var lis = $curlayer.find('.mfields li');
		
		var width = $curlayer.width();
		var liwidth = $curli.outerWidth(true);
		var index = $curli.index();

		var length = lis.length;
		var lnum = Math.floor(width/liwidth);
		var minindex = Math.floor(index/lnum) * lnum;
		var maxindex = (Math.floor(index/lnum) + 1) * lnum - 1;
		var lasindex = length - 1;
		if (maxindex > lasindex) {
			maxindex = lasindex;
		}
		//和三级联动同一行的表单项，其高度随着三级联动项高度的变化而变化。如果三级联动展开的高度超过了初始高度，那么就以三级联动展开的高度为标准，如果没有超出，那么就以初始高度为标准
		$curlayer.find('.mfields li').slice(minindex,maxindex+1).find('.inpbox').height('auto');
		htimer = setTimeout(function(){
			clearTimeout(htimer);
			var maxh = 0;
			for(var i = 0;i <= length;i++) {
				var height = $curlayer.find('.mfields li:eq('+i+')').find('.inpbox').height();
						maxh = height>maxh?height:maxh;
			}
			$curlayer.find('.mfields li').slice(minindex,maxindex+1).find('.inpbox').height(maxh);
			wp_heightAdapt($curlayer);
		}, 50);
    }
    
    function getVars(varDatas) {
        var tempVarArr = new Array();
        for (var j = 0; j < varDatas.length; j++){
            tempVarArr[j] = varDatas[j].varname;
        }
        return tempVarArr;
    }

    function isCorrect(formulaObj){
        var calErr = false;
        var vardatas = params.vardatas;
        vardatas = getVars(vardatas);
        var calDatas = new Array();
        var filterArr = new Array();
        formulaObj.each(function (i, o) {
            if((typeof $(o).attr('required')) != undefined){
                calDatas[i] = $(o).data('formula');
            }
        });

        if(calDatas.length > 0){
            var reg = /\[[0-9a-z]+\]/g;
            for(var i in calDatas){
                filterArr[i] = calDatas[i].match(reg);
            }

            for(var m in filterArr){
                if(filterArr[m]){
                    for(var k = 0; k < filterArr[m].length; k++){
                        if(vardatas.indexOf(filterArr[m][k]) == -1){
                            calErr = true;
                        }
                    }
                }
            }
        }
        return calErr;
    }

    var getQueenItem=function (id){
            return $('.fileQueue_chooser_'+window.id).find('.uploadifyQueueItem').filter(function(){
                    return this.id.match(new RegExp(id+'$'));
            })
    }
    return {valueRegExp:valueRegExp,ms5Hig:ms5Hig,getVars:getVars,isCorrect:isCorrect,getQueenItem:getQueenItem};
}

function layer_new_message_form_addid(params){
    var layerid =params.layerid;
    function add_id(id){
        window.id = id;
    }
    window.add_id=add_id;
    $(function(){
         var $curlayers = $('#'+layerid);
         var btnSelect = $curlayers.find(".btn-select").css("text-align");
         if(btnSelect=='right'){
             $curlayers.find(".cur_select").css({"width":"auto","margin-right":"32px"});
         }
     });
}

function layer_new_message_form_webuploader(params,langarr){
    var layerid =params.layerid;
    var limitsize = parseInt(params.limitsize);
    var maxPicSize = limitsize * 1048576;
    var pickid = '.'+layerid+'user_pic_upload';
    var $curlayer = $('#'+layerid);
    var curskn = params.curtheme;
    var innerfuncs=layer_new_message_form_createfuncs(params,langarr);

    var getQueenItem=function (id){
            return $('.fileQueue_chooser_'+window.id).find('.uploadifyQueueItem').filter(function(){
                    return this.id.match(new RegExp(id+'$'));
            })
    }

    function ms5Hig($curli){
		return innerfuncs['ms5Hig']($curli);
    }

    var mimetypestr = '';
    var mimetypearr = {
        'pic' : 'image/png,image/jpg,image/jpeg,image/gif,.ico',
        'mp3' : 'audio/mpeg',
        'swf' : '.swf','rar' : '.rar',
        'doc' : 'application/pdf,.doc,.docx,.ppt,.pptx,.odt,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'text' : 'text/plain,text/html'
    };
    
    var filetype = 'pic';
    mimetypestr = mimetypearr[filetype];

    var uploader = WebUploader.create({
        auto: false,
        swf: relativeToAbsoluteURL('script/webuploader/Uploader.swf'),
        server: parseToURL('wp_frontpage','locale_users_uploadify'),
        pick: {id:pickid,multiple:false},
        formData:{fileType:'ico|gif|jpg|jpeg|png',maxFileSize: maxPicSize},
        fileVal:'Filedata',
        resize: false,
        accept: {
            title: 'Images',
            extensions: 'gif,jpg,jpeg,bmp,png',
            mimeTypes: mimetypestr
        },
        thumb:{
            width: 40,
            height: 40,        
            quality: 70,
            allowMagnify: true, 
            crop: true 
        },
        compress: {
            width: 1600,
            height: 1600,
            quality: 90,
            allowMagnify: false,
            crop: false,
            preserveHeaders: true,
            noCompressIfLarger: false,
            compressSize: maxPicSize
        },
        duplicate:true
    });
    $('#canvas').data('new_message_form_uploader'+pickid,uploader);

    uploader.on( 'uploadSuccess', function( file,result ) {
        var fname = result.fname;
        $("#"+file.id).parent().next("input:hidden").val(fname);
        if(result.result=='ERROR'){
            var $li = $( '#'+file.id );
            var $percent = $li.find('.percentage');
            $percent.css('color','red').html(' - '+ result.errmsg);
        }  
    });

    uploader.on( 'uploadError', function( file,reason ) {
        alert(langarr.g['upload.failed']+': '+reason);
        var $li = $( '#'+file.id );
        var $percent = $li.find('.percentage');
        $percent.css('color','red').html(' - '+ langarr.g['upload.failed']+':'+reason);
    });

    uploader.on('error', function(file,max,fileobj){
        if(file=='F_EXCEED_SIZE'){   
            var uploadsize= max/1024/1024;
            getQueenItem(fileobj.id).find('.percentage').css('color','red').html(" - "+langarr.g['upload.maxFileSize']+((uploadsize>=1?uploadsize+'MB':uploadsize*1024+"KB")));
        }else if(file=='Q_EXCEED_NUM_LIMIT'){ 
            $('#'+fileobj.id).remove();
            uploader.removeFile(fileobj,true);
        }else if(file=='Q_TYPE_DENIED'){ 
            getQueenItem(max.id).find('.percentage').css('color','red').html(" - "+langarr.g['upload.illegal_format']);
        }
        //Remove item
        $('#'+fileobj.id+' a.WebupRemove').click(function(){
            if(curskn == 'ms3'){
                var oldname = $(this).parents('.filequeue').siblings('.uppic_hidden').attr('field_name');
                $(this).parents('.filequeue').siblings('.'+layerid+'user_pic_upload').children('.webuploader-pick').find('.webuploader-pick_txt').html(oldname);
            }else{
                $(this).parents('.filequeue').siblings('.'+layerid+'user_pic_upload').children('.webuploader-pick').find('.webuploader-pick_txt').html('');
            }
            $(this).parents('.filequeue').css({'border':'none','height':'auto'});
            $('#'+fileobj.id).remove();
            wp_heightAdapt($curlayer);
        });
        wp_heightAdapt($curlayer);
    });

    uploader.on( 'beforeFileQueued', function( file ) {
        var itemData = {
            'fileID'     : file.id,
            'instanceID' : file.id,
            'fileName'   : file.name,
            'fileSize'   : WebUploader.formatSize(file.size),
            'cancelpng'   : relativeToAbsoluteURL('script/multiupload/cancel.png'),
            'className'   : 'uploadifyQueueItem'
        }
        // Create the file item template
        var itemTemplate = '<div id="${fileID}" class="${className}">\
            <div class="cancel">\
                <a class="WebupRemove" href="javascript:;"><img src="${cancelpng}" border="0" /></a>\
            </div>\
            <img style="width:48px;height:48px;margin-right:3px;" class="${fileID}"><span class="fileName">${fileName} (${fileSize})<span>'+langarr.g['compress_limit_hint']+'</span></span><span class="percentage"></span>\
            \
        </div>';
                
        // Replace the item data in the template
        var itemHTML = itemTemplate;
        for (var d in itemData) {
            itemHTML = itemHTML.replace(new RegExp('\\$\\{' + d + '\\}', 'g'), itemData[d]);
        }

        // Add the file item to the queue
        var $chooser = $('.fileQueue_chooser_'+window.id);
        var oldfileid = $chooser.find(".uploadifyQueueItem").attr("id");
        if($chooser.children().length){
            var queen_exitfile = uploader.getFile(oldfileid);
            if(queen_exitfile) uploader.removeFile(queen_exitfile,true);
            
            $chooser.empty(itemHTML);
        }else{
            $chooser.css({'border':'1px solid #dedede'});
            if(curskn == 'ms4'){
                var filequeen_height = $chooser.parents("li:eq(0)").outerHeight(true);
                $chooser.css({'border':'1px solid #dedede','height':filequeen_height-2});
                $chooser.parent('.inpbox').height('auto');
            }
        }
        if (curskn == 'ms5') {
            var $curli = $chooser.parents('li')
            ms5Hig($curli);
        }
        $chooser.append(itemHTML);
        $chooser.siblings('.'+layerid+'user_pic_upload').children('.webuploader-pick').find('.webuploader-pick_txt').html(langarr.g['selected 1 pictures']);
        if ($chooser.children('.jscroll-c').length) $chooser = $chooser.children('.jscroll-c');
    });

    uploader.on( 'fileQueued', function( file ) {
        $curlayer.find('.mesform').find(".uppic_hidden").each(function(){

            var is_required = $(this).attr("required");
            if(is_required){
                var is_add_queen = $(this).siblings('.filequeue').html();
                if(is_add_queen){
                    $(this).parents('li').find('span.requiredtip').remove();
                    $(this).parents('li').find('input[name=file]').removeAttr('required')
                        .removeAttr('aria-required').removeAttr('aria-invalid');
                }
            }
        });
        uploader.makeThumb( file, function( error, src ) {
            if ( error ) {
                $("."+file.id).replaceWith("<span>"+langarr.g['cannot preview']+"</span>");
                return;
            }
            $("."+file.id).attr( 'src', src );
        }, 1, 1 );
        //Remove item
        $('#'+file.id+' a.WebupRemove').click(function(){
            if(curskn == 'ms3'){
                var oldname = $(this).parents('.filequeue').siblings('.uppic_hidden').attr('field_name');
                $(this).parents('.filequeue').siblings('.'+layerid+'user_pic_upload').children('.webuploader-pick').find('.webuploader-pick_txt').html(oldname);
            }else{
                $(this).parents('.filequeue').siblings('.'+layerid+'user_pic_upload').children('.webuploader-pick').find('.webuploader-pick_txt').html('');
            }
            $(this).parents('.filequeue').css({'border':'none','height':'auto'});
            $curli = $(this).parents('li');
            $('#'+file.id).remove();
            uploader.removeFile(file,true);
            if (curskn == 'ms5') {
                ms5Hig($curli);
            } else {
                wp_heightAdapt($curlayer);
            }
        });
        wp_heightAdapt($curlayer);
    });



    return uploader;
}

function layer_new_message_form_select_datepicker(params,langarr){
    var layerid =params.layerid;
	var $curlayer = $('#'+layerid);
	var curskn = params.curtheme;
    var datedir = params.datedir;
    // Custom-select
	$curlayer.find('select.cp_sele').change(function(){
		$(this).closest('.btn-select').removeClass("on");
		$(this).prev('span.cur_select').html($('> option:selected', this).html());

        if($('.define_limit2').css('display') == 'block'){
            $(".requiredtip").hide();
        }

        if($('.define_limit3').css('display') == 'block'){
            $(".requiredtip").hide();
        }
	}).focus(function(){$(this).closest('.btn-select').addClass("on")})
	.blur(function(){$(this).closest('.btn-select').removeClass("on")});
	// Radio:checked & Checkbox:checked
	$curlayer.find(':checkbox').click(function(){
		$(this).parent()[$(this).prop("checked")?'addClass':'removeClass']("on");
    });
    $curlayer.find(':radio').click(function(){
        var hasRequire=false;
        if($(this).closest('.radiobox').parent().find(':radio[required]').length){
            hasRequire=true;
        }
        if(hasRequire){
            $(this).parent()[$(this).prop("checked")?'addClass':'removeClass']("on");
            $(this).parent().siblings('.radiobox').removeClass("on");
        }else{
            if($(this).closest('.radiobox').is('.on')){
                $(this).prop('checked',false);
                $(this).closest('.radiobox').removeClass("on");
            }else{
                $(this).parent()[$(this).prop("checked")?'addClass':'removeClass']("on");
                $(this).parent().siblings('.radiobox').removeClass("on");
            }
        }
    });
    
    // Datepicker
	if (params.datepicker == 'datepicker') {
		if ($('link#date_picker').length == 0) {
			$('<link id="date_picker" rel="stylesheet" />').attr({
				"type" : 'text/css',"href" : datedir+'/jquery.cxcalendar.css'
			}).appendTo('head');
		}
		$LAB.script(datedir+'/jquery.cxcalendar.min.js?v=2').wait(function(){
			$curlayer.find('input.datepicker').not('.datepickers').cxCalendar({language:params.date_locale});
		});
	}
	if (params.datepickers == 'datepickers') {
		if ($('link#date_picker').length == 0) {
			$('<link id="date_picker" rel="stylesheet" />').attr({
				"type" : 'text/css',"href" : datedir+'/jquery.cxcalendar.css'
			}).appendTo('head');
		}
		$LAB.script(datedir+'/jquery.cxcalendar.min.js?v=2').wait(function(){
			$curlayer.find('input.datepickers').cxCalendar(
				{
					language: params.date_locale,
  					type: 'datetime',
  					format: 'YYYY-MM-DD HH:mm:ss'
				}
			);
		});
	}

}

function layer_new_message_form_agreecheck(params,langarr){
    $('.agree_check').click(function(){
		var ischeck = $(this).prop('checked');
		if (ischeck) {
			$(this).addClass('check');
		} else {
			$(this).removeClass('check');
		}
	});
}

function layer_new_message_form_load_style_ui(params,langarr){
    var layerid = params.layerid;
	var $curlayer = $('#'+layerid);
    var curskn = params.curtheme;

    // Placeholder
	if (curskn == 'ms3') {
		var decode = function(str){return (str||'').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&#039;/g, "'")};
		$curlayer.find('input[type="text"],select,textarea').each(function(i, node){
			var $parent = $(node).parent(),$title = $parent.closest('li').children('.title'),$reqtip = $([]);
			if ($title.children('.reqtip').length > 0) $reqtip = $title.children('.reqtip').detach();
			if ($parent.is('.inpbox')){
                  $(node).attr('placeholder',decode($title.hide().html()||''));
                  $LAB.script(relativeToAbsoluteURL('script/userloginpc/jquery.placeholder.min.js')).wait(function(){
                           $(node).placeholder();
                  })  
               }else {
                // bug-9767
                var fatherid = 	$('#'+layerid).attr('fatherid');
                $('#'+fatherid+'_pop_up' ).css({'display':'block','visibility':'hidden'});
				if ($parent.is(':hidden')){
					$('#'+fatherid+'_pop_up' ).css({'display':'none','visibility':'visible'});
					return true;
				}
				$parent.children('span.cur_select').html($title.hide().html());
                $('#'+fatherid+'_pop_up' ).css({'display':'none','visibility':'visible'});
            }
			if ($reqtip.length) $reqtip.css({"position": 'absolute',"right": '-10px',"top": '0'}).appendTo($title.next('.inpbox').css("position", 'relative'));
		}); 
                
        $curlayer.find('.'+layerid+'user_pic_upload').each(function(){
            var pictitle_node = $(this).parent('.inpbox').siblings('.title'),$picreqtip = $([]);
            if(pictitle_node.children('.reqtip').length > 0) $picreqtip = pictitle_node.children('.reqtip').detach();
            var pictitle = pictitle_node.html();
            $(this).find('.webuploader-pick_txt').html(pictitle);
            pictitle_node.hide();
            if($picreqtip.length) $picreqtip.css({"position": 'absolute',"right": '-10px',"top": '0'}).appendTo($(this).parent('.inpbox').css("position", 'relative'));
        });
    } else if (curskn == 'ms2') {/*Title line-height*/
		var $inpbox = $([]);
		$curlayer.find('ul > li').each(function(i, node){
			var $title = $('> .title', node);$inpbox = $('> .inpbox', node);
			$title.css("padding-top", Math.ceil(Math.max($inpbox.height() - $title.height())/2)+'px').css("visibility",'visible');
		});
		var func=function(){
			var boxel=$curlayer.find('ul > li:last > .inpbox');	
			if(boxel.is(':visible')){
				var inpos = boxel.position();
				if(boxel.length>0)$curlayer.find('a.btnsubmit').css("margin-left", inpos.left+'px');
			}else{
				setTimeout(function(){
					func();
				},60);
			}
		}
		func();
		
	} else if (curskn == 'ms4') {/*Inpbox max-height*/
		var $lis = $curlayer.find('ul > li');
		for(var i = 0,c = $lis.length;i < c;i += 2){
			var maxh = 0;if(c == i + 1) break;
			var $inpbox = $lis.filter(':eq('+i+')').next('li').andSelf().children('.inpbox').height('auto');
			maxh = Math.max.apply(null, $inpbox.map(function(){return $(this).height()}).toArray());
			if ($('#'+$curlayer.attr('fatherid')).attr('type') != 'pop_up' && maxh>10) {
				$inpbox.height(maxh);
			}
		}
	} else if (curskn == 'ms5') {
		//取最高的表单项的高度，设置给所有表单项，防止显示错误
		var fatherid = 	$('#'+layerid).attr('fatherid');
		var ofatdisp = $('#'+fatherid+'_pop_up' ).css('display');
		if (ofatdisp == 'none') {
			$('#'+fatherid+'_pop_up' ).css({'display':'block','visibility':'hidden'});
		}
		var $lis = $curlayer.find('ul > li');
		var maxh = 0;
		var $inpbox = $lis.children('.inpbox')
		$lis.each(function(i){
			var height = $(this).children('.inpbox').height();
			maxh = height>maxh?height:maxh;
		});
		$inpbox.height(maxh);
		if (ofatdisp == 'none') {
			$('#'+fatherid+'_pop_up' ).css({'display':'none','visibility':'visible'});
		}
	}
	// Captcha
	if (params.use_auth_code) {
		var $captchapic = $curlayer.find('img.captchapic'),$cainp = $captchapic.siblings('.inptext'),
		inptxtind = parseInt($cainp.css("text-indent")||'0');
		//fix bug 11827留言模块验证码 通栏固定显示异常
		if (curskn == 'ms5' && $('#'+fatherid).attr('infixed') == '1' && inptxtind > 5) {
			inptxtind = 5;
		}
		if($cainp.data('has_text-indent')) inptxtind =$cainp.data('has_text-indent');
		$cainp.data('has_text-indent',inptxtind);
		var capicleft = inptxtind + parseInt($cainp.css("borderLeftWidth")||'0');
		$cainp.css("text-indent", (inptxtind + 65 + 10)+'px');
		var func=function(){
			if($cainp.is(':visible')){
				$captchapic.css({"top": Math.ceil(($cainp.outerHeight(true) - 18)/2)+'px',"left": capicleft+'px'})
			}else{
				setTimeout(function(){
					func();
				},60);
			}
		}
		func();
		$captchapic.click(function(){
			$(this).attr("src", parseToURL('new_message_form', 'captcha', {"capkey": layerid,"s": (new Date()).getTime()}));
		});
        $cainp.keyup(function(){
            var str = $cainp.val();
            if(str.match(/^[0-9]$/)===null){
                suboptstr = '<span class="requiredtip" style="top:41px;">该字段必须是数字<span class="tipshadow"></span><span class="pointytip"></span></span>';
                $cainp.parent().append(suboptstr);
            }
            if(str.match(/^[0-9]$/)!==null){
                $cainp.parent().children('.requiredtip').remove();
            }
        });
	}
}


function layer_new_message_form_validate_success(params,langarr,label){
    var layerid =params.layerid;
	var $curlayer = $('#'+layerid);

    var inpnstr = (label.attr("id")||'').replace('-error', '');
    if(inpnstr.indexOf('multiselect')>0){
        if($curlayer.find(".district_limit2").val()){
            if($curlayer.find(".district_limit3").val()){
                $curlayer.find('[name="'+inpnstr+'"]').closest('.inpbox').children('.requiredtip').remove();
            }else{
                if($curlayer.find(".district_limit3").closest('a').css('display') == 'none'){
                    $curlayer.find('[name="'+inpnstr+'"]').closest('.inpbox').children('.requiredtip').remove();
                }
            }
        } else{
            if(inpnstr.indexOf('[1]') > 0){
                if(inpnstr.indexOf('[2]') < 0){
                    if(!$curlayer.find(".define_limit2").val()){
                        $curlayer.find('[name="'+inpnstr+'"]').closest('.inpbox').children('.requiredtip').remove();
                    }
                }
            }else if(inpnstr.indexOf('[2]') > 0){
                if($curlayer.find(".define_limit3").css("display") == 'none' || !$curlayer.find(".define_limit3").css("display")){
                    $curlayer.find('[name="'+inpnstr+'"]').closest('.inpbox').children('.requiredtip').remove();
                }
            }else if(inpnstr.indexOf('[3]') > 0 || inpnstr.indexOf('[3]') < 0){
                $curlayer.find('[name="'+inpnstr+'"]').closest('.inpbox').children('.requiredtip').remove();
            }
        }
    }else{
        $curlayer.find('[name="'+inpnstr+'"]').closest('.inpbox').children('.requiredtip').remove();
    }
}

function layer_new_message_form_error_placement(params,langarr,error, el){
    var curskn = params.curtheme;
    var layerid =params.layerid;
	var $curlayer = $('#'+layerid);

    var $tiparent = el.closest('.inpbox'),$reqtip = $tiparent.children('.requiredtip');
    if ($reqtip.length > 0) $reqtip.remove();
    var _top = $tiparent.outerHeight(),tipmsg = langarr.m["Isrequired"];
    var tiptype='required';
    if (el.val().length && (el.attr("data-rule-email") == 'true')){
        tipmsg = langarr.m["Email error"];
        tiptype='email';
    }
    if (el.val().length && (el.attr("data-rule-mobile") == 'true')) {
        tipmsg = langarr.m["Mobile error"];
        tiptype='mobile';
    }
    if (el.val().length && (el.attr("data-rule-Idcard") == 'true')){
        tipmsg = langarr.m["Idcard error"];
        tiptype='Idcard';
    }
    if (el.val().length && (el.attr("data-rule-number") == 'true')){
        tipmsg = langarr.g["Please enter a pure number"];
        tiptype='number';
    }
    if(curskn == 'ms5'){
        $curlayer.find(".mesform").css({'overflow':''});
    }
    if(window['wopop_define_message_error_text']){
        var newmsg=window['wopop_define_message_error_text'](tiptype,tipmsg);
        if(newmsg && $.trim(newmsg)!="") tipmsg=newmsg;
    }

    $tiparent.css("position", 'relative').append('<span class="requiredtip" style="top:'+_top+'px;">'
        +tipmsg+'<span class="tipshadow"></span><span class="pointytip"></span></span>');
}

function layer_new_message_form_btnsubmit(params,langarr){
    var layerid =params.layerid;
    var $curlayer = $('#'+layerid);

    $curlayer.find('a.btnsubmit').unbind('click').click(function(){
        var vercodeShow = $curlayer.find("input[name=vercode]").css('display');
        var duanxinShow = $curlayer.find("input[name=verify]").css('display');
        if (vercodeShow == "inline-block" && duanxinShow == 'block') {
            $curlayer.find("input[name=vercode]").attr('required',true);
        }
        
        $curlayer.find('.mesform').find(".uppic_hidden").each(function(){
            var has_re_pic_upload = $curlayer.find('.mesform .uppic_hidden[required]').length;
            if (has_re_pic_upload) {
                var is_required = $(this).attr("required");
                if(is_required){
                    var is_add_queen = $(this).siblings('.filequeue').html();
                    if(!$(this).parents('li').find('input[name=file]').attr('required') && is_add_queen == ''){
                        $(this).parents('li').find('input[name=file]').attr('required','required');
                    }

                    if(is_add_queen == ''){
                        var pictipmsg =  langarr.m["Isrequired"];
                        var vcodetiparent = $(this).siblings('.webuploader-container');
                        var vcodereqtip = vcodetiparent.find('span.requiredtip');
                        if (vcodereqtip.length > 0) vcodereqtip.remove();
                        var _top = vcodetiparent.outerHeight();

                        vcodetiparent.append('<span class="requiredtip" style="top:'+_top+'px;">'
                            +pictipmsg+'<span class="tipshadow"></span><span class="pointytip"></span></span>');

                    }
                }
            }
        });

	    if($curlayer.find("input[data-rule-mobile=true]").val() && !$curlayer.find("input[name=verify]").val()){

            var codetipmsg = langarr.m["Isrequired"];
            var vcodetiparent = $('#'+layerid).find("a.send");
            var vcodereqtip = vcodetiparent.children('.requiredtip');
            if (vcodereqtip.length > 0) vcodereqtip.remove();
            var _top = vcodetiparent.outerHeight();

            vcodetiparent.append('<span class="requiredtip" style="top:'+_top+'px;">'
                +codetipmsg+'<span class="tipshadow"></span><span class="pointytip"></span></span>');

            $curlayer.find("input[name=verify]").attr('required','requierd');
        }
        var agree_check = $('.agree_check');
		if ((agree_check.length > 0 && !agree_check.prop('checked'))) {
            alert(langarr.g['Please accept the agreement!']);
			return false;
		}
	    $curlayer.find('.mesform').submit();
	});
}

function layer_new_message_form_getVarAndVal(cal_var,valueRegExp){
    var var_num = {};
    cal_var.each(function(){
        var ftype = $(this).data('type');
        var val = 0;
        var iname = '';
        var varname = '';
        if(ftype == 'calnumber'){
            iname = $(this).attr('name');
            val = $(this).val();
            varname = valueRegExp(iname);
            var_num['['+varname+']'] = val;
        }else if(ftype == 'radio'){
            if($(this).hasClass('on')){
                iname = $(this).children('input').attr('name');
                val = $(this).children('input').data('val');
                varname = valueRegExp(iname);
                var_num['['+varname+']'] = val;
            }
        }else if(ftype == 'select'){
            iname = $(this).attr('name');
            val = $(this).find('option:selected').data('val');
            varname = valueRegExp(iname);
            var_num['['+varname+']'] = val;
        }
    });
    return var_num;
}

function layer_new_message_form_uploadComplete($curlayer,uploader,required_pic_post_f,choose_pic_post_f){
    $curlayer.find('.mesform').find(".uppic_hidden").each(function(){
        var is_required = $(this).attr("required");
        var imgstr = $(this).val();
        if(is_required){
            if(imgstr == ''){
                required_pic_post_f = false;
                return false;
            }else{
                required_pic_post_f = true;
            }
        }
    })
    //选择上传的图片是否全部上传
    $curlayer.find('.mesform').find(".filequeue").each(function(){
        var uppic_hidden_node = $(this).siblings('.uppic_hidden');
        var is_choose_pic = $(this).html();
        var imgstr2 = uppic_hidden_node.val();
        if(is_choose_pic !=''){
            if(imgstr2 == ''){
                choose_pic_post_f = false;
                return false;
            }else{
                choose_pic_post_f = true;
            }
        }
    })
    
    return {'choose_pic_post_f':choose_pic_post_f,'required_pic_post_f':required_pic_post_f}
}

function layer_new_message_form_yzm(yzm_open,langarr,$curlayer){
    if(yzm_open){
        var inputVal = $curlayer.find("input[name=verify]").val();
        if(!inputVal){
            var codetipmsg = langarr.m['Isrequired'];
            var vcodetiparent = $curlayer.find("a.send");
            var vcodereqtip = vcodetiparent.children('.requiredtip');
            if (vcodereqtip.length > 0) vcodereqtip.remove();
            var _top = vcodetiparent.outerHeight();

            vcodetiparent.append('<span class="requiredtip" style="top:'+_top+'px;">'
                +codetipmsg+'<span class="tipshadow"></span><span class="pointytip"></span></span>');
            return false;
        }
    }
    return true;
}

function layer_new_message_form_submit_return($curlayer,form,skn,useauthcode,default_name){
    var curskn=skn;
    $curlayer.find('.mesform').find(".uppic_hidden").each(function(){
        $(this).val('');
    });
    $curlayer.find('.mesform').find(".filequeue").each(function(){
        $(this).html('');
        $(this).css({'border':'none','height':'auto'});
    });
    $curlayer.find('.mesform').find(".webuploader-pick_txt").each(function(){
        if(curskn == 'ms3'){
            var oldname = $(this).parents('.webuploader-container').siblings('.uppic_hidden').attr('field_name');
            $(this).html(oldname);
        }else{
            $(this).html('');
        }
    });						 
    
    $('.radiobox, .checkbox', form).removeClass("on");
    $curlayer.find('.agree_check').removeClass('check');
    $('.btn-select > span.cur_select', form).html(function(){
        var tipstr = ' --- ',$li = $(this).closest('li');
        if (skn == 'ms3') tipstr = $li.children('.title').html()||' --- ';
        $li.find('> .inpbox > .btn-select:gt(0)').hide();
        if(default_name != '---'){
            tipstr = default_name;
        }
        return tipstr;
    });
    if (useauthcode == 'yes') $('img.captchapic', form).trigger("click");
    wp_heightAdapt($curlayer);
}